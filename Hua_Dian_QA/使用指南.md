# 华电问答机器人 (Hua_Dian_QA) 使用指南 (v2.2)

欢迎使用华电问答机器人！这是一个基于本地大语言模型（LLM）和检索增强生成（RAG）技术的智能问答系统。您可以通过一个直观的 Web 界面，与自己的文档进行对话。

---

### ✨ 核心功能

*   **完全本地化**：所有计算（包括大语言模型推理）都在您自己的机器上运行，确保数据隐私和安全。
*   **一体化 Web 界面**：在一个界面中完成提问、上传/删除文档、更新知识库等所有操作。
*   **无需重启**：更新知识库后，系统会在后台自动完成加载，问答服务不中断。
*   **智能增量更新**：系统能自动检测文档变更，只更新变化部分，大幅缩短更新时间。
*   **多种文档格式支持**：支持 `.txt`, `.pdf`, `.docx` 等常见文档格式。

---

## 📚 目录

1.  [环境准备](#-环境准备)
2.  [快速上手](#-快速上手)
3.  [详细功能说明](#-详细功能说明)
    *   [智能问答](#智能问答)
    *   [知识库管理](#知识库管理)
4.  [开发者指南](#-开发者指南)

---

### ⚙️ 环境准备

在开始之前，请确保您已完成以下环境配置。

#### 1. 安装 Ollama

本系统使用 [Ollama](https://ollama.com/) 来运行本地大语言模型。

*   访问 [Ollama 官网](https://ollama.com/) 并根据您的操作系统（Windows, macOS, Linux）下载并安装。
*   **（推荐）GPU 加速**：如果您的机器有 NVIDIA 显卡，请确保已安装相应的 CUDA 驱动，Ollama 会自动利用 GPU 进行加速。

#### 2. 创建本地大模型

本项目需要一个名为 `huadian-llm` 的本地模型。您需要通过项目提供的 `Modelfile` 来创建它。

1.  **拉取基础模型**：打开终端或命令行，运行以下命令来下载本项目所需的基础大语言模型。**这一步至关重要**，因为 `Modelfile` 是基于此模型的。
    ```bash
    ollama pull deepseek-llm
    ```

2.  **创建自定义模型**：在终端中，导航到 `Hua_Dian_QA` 项目的根目录，然后运行以下命令。
    ```bash
    ollama create huadian-llm -f ./Modelfile
    ```
    该命令会根据 `Modelfile` 中的配置（如使用GPU、设置回答的确定性等），创建一个名为 `huadian-llm` 的新模型。我们的应用将专门调用这个模型。

#### 3. 安装 Python 依赖

1.  **创建并激活虚拟环境**（推荐）：
    ```bash
    python -m venv .venv
    # Windows
    .venv\Scripts\activate
    # macOS / Linux
    source .venv/bin/activate
    ```

2.  **安装依赖库**：
    ```bash
    pip install -r requirements.txt
    ```

---

### 🚀 快速上手

完成环境准备后，您只需一个命令即可启动整个应用。

1.  **启动 Web 应用**：
    *   在项目根目录的终端中（确保已激活虚拟环境），执行以下命令：
      ```bash
      python Hua_Dian_QA/main.py webapp
      ```
    *   终端会显示一个本地 URL (例如 `http://127.0.0.1:7860`)。

2.  **开始使用**：
    *   在浏览器中打开上述 URL。
    *   **首次启动**：系统会检查知识库。如果为空，您可以直接进入“知识库管理”选项卡上传您的第一个文档。
    *   **上传文档**：在“知识库管理”中，点击“上传文件”，选择您的文档。上传后，系统会自动执行一次**增量更新**，将新文档加入知识库。
    *   **开始提问**：更新完成后，切换到“智能问答”选项卡，即可开始就您上传的文档内容进行提问。

---

### 📖 详细功能说明

#### 智能问答

这是应用的核心交互界面。

*   **聊天窗口**：显示您与机器人的对话历史。
*   **问题输入框**：在此输入您的问题，按 Enter 键发送。
*   **清除对话**：清空当前的对话历史，开始一次全新的对话。
*   **参考来源**：机器人的回答会附上其内容所依据的源文档名称，方便您溯源。

#### 知识库管理

您可以在此管理作为机器人知识来源的所有文档。

*   **文档列表**：
    *   显示当前 `Hua_Dian_QA/docs/` 目录下的所有文档。
    *   **刷新列表**：手动刷新以查看最新的文件列表。
    *   **选择文件**：点击复选框以选择要删除的文件。

*   **文件操作**：
    *   **上传文件**：点击此按钮，可以选择一个或多个文件上传到知识库。上传成功后，文件会出现在列表中。
    *   **删除选中**：删除在列表中选中的所有文件。

*   **知识库更新**：
    *   **增量更新 (推荐)**：点击后，系统会扫描文档的变更（新增、修改），并只对这些变更建立索引。这是最快、最常用的更新方式。**每次上传或删除文件后，建议执行此操作。**
    *   **强制重建**：点击后，系统会删除旧的知识库，并根据当前 `docs` 目录下的所有文件从头构建一个新的。此操作耗时较长，仅在您怀疑知识库出现问题时使用。
    *   **状态显示**：所有操作（文件管理、知识库更新）的结果和状态都会在对应的状态框中显示。

---

### 👨‍💻 开发者指南

#### API 模式

除了 `webapp` 模式，本应用还支持纯 `api` 模式，方便与其他应用集成。

*   **启动命令**：
    ```bash
    python Hua_Dian_QA/main.py api
    ```
*   **API 文档**：
    *   启动后，在浏览器中访问 `http://12.0.0.1:8000/docs`，即可查看由 FastAPI 自动生成的 Swagger UI 交互式 API 文档。
    *   所有 Web 界面的功能，如提问 (`/ask`)、文件管理 (`/files/*`)、知识库更新 (`/kb/*`)，都有对应的 API 端点。